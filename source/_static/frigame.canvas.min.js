!function(t){"use strict";var e={};t.extend(t.PGradient,{initCanvas:function(){var t=this.startColor,e=this.endColor;t===e?this.style=this.startColorStr:(this.gradients={},this.gradient_groups={}),this.canvas_initialized=!0},addGroup:function(e,i){var r,a,o,s=i.width,h=i.height,n=i.name;this.canvas_initialized||this.initCanvas(),a=this.gradients,a&&(this.type===t.GRADIENT_HORIZONTAL?(r=s,h=0):(r=h,s=0),a[r]||(o=e.createLinearGradient(0,0,s,h),o.addColorStop(0,this.startColorStr),o.addColorStop(1,this.endColorStr),a[r]={style:o,groups:{}}),a[r].groups[n]=!0,this.gradient_groups[n]=r)},removeGroup:function(e){var i,r,a,o=e.name;this.canvas_initialized||this.initCanvas(),r=this.gradients,r&&(a=this.gradient_groups,void 0!==a[o]&&(i=a[o],a[o]=null,delete a[o],r[i]&&(a=r[i].groups,a[o]&&(a[o]=null,delete a[o],t.isEmptyObject(a)&&(r[i]=null,delete r[i])))))},setFillStyle:function(e,i){var r,a=i.width,o=i.height;this.style?e.fillStyle=this.style:(r=this.type===t.GRADIENT_HORIZONTAL?a:o,e.fillStyle=this.gradients[r].style)},setStrokeStyle:function(e,i){var r,a=i.width,o=i.height;this.style?e.strokeStyle=this.style:(r=this.type===t.GRADIENT_HORIZONTAL?a:o,e.strokeStyle=this.gradients[r].style)},drawBackground:function(t,e){this.setFillStyle(t,e),t.fill()}}),t.extend(t.PAnimation,{drawBackground:function(e,i){var r=this.options.frameset[0].img,a=this.style;i.options.backgroundType===t.BACKGROUND_STRETCHED?t.safeDrawImage(e,r,0,0,r.width,r.height,0,0,i.width,i.height):(a||(a=e.createPattern(r,"repeat"),this.style=a),e.fillStyle=a,e.fill())}}),t.extend(t.PSprite,{draw:function(e){var i,r,a,o,s=Math.round,h=this.options,n=h.animation,l=h.angle,d=h.scaleh,p=h.scalev,g=h.alpha,u=this.left,m=this.top,c=this.width,f=this.height,v=this.halfWidth,y=this.halfHeight,b=this.prevLeft,w=this.prevTop,G=t.frameCounter-1,C=h.currentFrame,S=t.ctx;(u!==b||m!==w)&&(G!==this.frameCounterLastMove?(this.prevLeft=u,this.prevTop=m,this.frameCounterLastMove=G):(m=s(m*e+w*(1-e)),u=s(u*e+b*(1-e)))),o=t.insidePlayground(u,m,c,f),o&&n&&g&&d&&p&&!h.hidden&&(a=this.animation_options.frameset[h.currentSpriteSheet],i=t.globalAlpha,1!==g?(t.globalAlpha*=g,S.globalAlpha=t.globalAlpha,r=!0):r=!1,l||1!==d||1!==p?(S.save(),S.translate(u+v,m+y),l&&S.rotate(l),(1!==d||1!==p)&&S.scale(d,p),t.safeDrawImage(S,a.img,a.offsetx+h.multix+C*a.deltax,a.offsety+h.multiy+C*a.deltay,c,f,-v,-y,c,f),S.restore()):t.safeDrawImage(S,a.img,a.offsetx+h.multix+C*a.deltax,a.offsety+h.multiy+C*a.deltay,c,f,u,m,c,f),r&&(S.globalAlpha=i),t.globalAlpha=i)}}),e.PSpriteGroup=t.pick(t.PSpriteGroup,["init","remove","draw"]),t.extend(t.PSpriteGroup,{init:function(i,r,a){var o,s,h,n;this.old_options={},a||(o=r.parentDOM,o.getContext?(this.dom=null,t.ctx=o.getContext("2d"),r.width=o.width||300,r.height=o.height||150):(s=r.width,h=r.height,n=document.createElement("canvas"),n.id=t.domPrefix+i,n.width=s,n.height=h,o.insertBefore(n,o.firstChild),n.className=t.cssClass,t.extend(n.style,{left:"0px",top:"0px",width:String(s)+"px",height:String(h)+"px",overflow:"hidden"}),this.dom=n,t.ctx=n.getContext("2d"))),e.PSpriteGroup.init.apply(this,arguments),this.gradients={}},remove:function(){var t=this.options.background,i=this.old_options.background,r=this.options.borderColor,a=this.old_options.borderColor,o=this.dom;e.PSpriteGroup.remove.apply(this,arguments),i&&i.removeGroup&&i.removeGroup(this),t&&t.removeGroup&&t.removeGroup(this),a&&a.removeGroup&&a.removeGroup(this),r&&r.removeGroup&&r.removeGroup(this),o&&o.parentNode&&o.parentNode.removeChild(o)},draw:function(i){var r,a,o,s,h,n,l,d,p=Math.round,g=this.options,u=this.old_options,m=this.parent,c=this.left,f=this.top,v=this.width,y=this.height,b=this.halfWidth,w=this.halfHeight,G=this.prevLeft,C=this.prevTop,S=t.frameCounter-1,x=u.background,A=g.borderTopLeftRadius,P=g.borderTopRightRadius,T=g.borderBottomRightRadius,R=g.borderBottomLeftRadius,k=A||P||T||R,_=g.borderWidth,L=_/2,I=u.borderColor,D=v!==u.width||y!==u.height,N=g.angle,O=g.scaleh,M=g.scalev,B=g.alpha,E=g.crop,H=t.ctx;m||(H.clearRect(0,0,v,y),t.globalAlpha=1),(c!==G||f!==C)&&(S!==this.frameCounterLastMove?(this.prevLeft=c,this.prevTop=f,this.frameCounterLastMove=S):(f=p(f*i+C*(1-i)),c=p(c*i+G*(1-i)))),r=t.insidePlayground(c,f,v,y),a=r&&g.background,o=r&&_&&g.borderColor,s=a!==x,h=o!==I,r&&(s||h||D)&&((s||D)&&(x&&x.removeGroup&&(this.gradients[x.name]-=1,(D||!this.gradients[x.name])&&x.removeGroup(this)),a&&a.addGroup&&(this.gradients[a.name]?this.gradients[a.name]+=1:this.gradients[a.name]=1,a.addGroup(H,this)),u.background=a),(h||D)&&(I&&I.removeGroup&&(this.gradients[I.name]-=1,(D||!this.gradients[I.name])&&I.removeGroup(this)),o&&o.addGroup&&(this.gradients[o.name]?this.gradients[o.name]+=1:this.gradients[o.name]=1,o.addGroup(H,this)),u.borderColor=o),u.width=v,u.height=y),(this.layers.length||a||o)&&B&&O&&M&&!g.hidden&&(N||1!==O||1!==M?(H.save(),d=!0,H.translate(c+b,f+w),N&&H.rotate(N),(1!==O||1!==M)&&H.scale(O,M),H.translate(-b,-w)):c||f?(H.save(),d=!0,H.translate(c,f)):d=!1,n=t.globalAlpha,1!==B?(t.globalAlpha*=B,H.globalAlpha=t.globalAlpha,l=!0):l=!1,(a||E)&&(H.beginPath(),k?t.roundedRect(H,0,0,v,y,A,P,T,R):H.rect(0,0,v,y),H.closePath()),a&&a.drawBackground(H,this),o&&(H.beginPath(),k?t.roundedRect(H,-L,-L,v+_,y+_,A?A+L:0,P?P+L:0,T?T+L:0,R?R+L:0):H.rect(-L,-L,v+_,y+_),H.closePath(),o.setStrokeStyle(H,this),H.lineWidth=_,H.stroke()),E&&(d||(H.save(),d=!0),o&&(H.beginPath(),k?t.roundedRect(H,0,0,v,y,A,P,T,R):H.rect(0,0,v,y),H.closePath()),H.clip()),e.PSpriteGroup.draw.apply(this,arguments),d?H.restore():l&&(H.globalAlpha=n),t.globalAlpha=n)}}),t.safeDrawImage=function(t,e,i,r,a,o,s,h,n,l){e&&t&&(0>i&&(s-=n/a*i,a+=i,i=0),0>r&&(h-=l/o*r,o+=r,r=0),i+a>e.width&&(n=n/a*(e.width-i),a=e.width-i),r+o>e.height&&(l=l/o*(e.height-r),o=e.height-r),o>0&&a>0&&i<e.width&&r<e.height&&t.drawImage(e,i,r,a,o,s,h,n,l))},t.roundedRect=function(t,e,i,r,a,o,s,h,n){var l=Math.PI,d=l/2,p=e+r,g=i+a,u=e+o,m=p-s,c=g-h,f=e+n,v=i+o;t.moveTo(u,i),t.lineTo(m,i),s&&t.arc(m,i+s,s,-d,0,!1),t.lineTo(p,c),h&&t.arc(p-h,c,h,0,d,!1),t.lineTo(f,g),n&&t.arc(f,g-n,n,d,l,!1),t.lineTo(e,v),o&&t.arc(u,v,o,l,-d,!1)}}(friGame);