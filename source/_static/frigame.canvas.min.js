(function(t,i){"use strict";var e={};t.extend(i.PGradient,{initCanvas:function(){var t=this.startColor,i=this.endColor;t===i?this.fillStyle=this.startColorStr:(this.gradients={},this.gradient_groups={}),this.canvas_initialized=!0},addGroup:function(t){var e,a,h,r=i.ctx,o=t.width,s=t.height,l=t.name;this.canvas_initialized||this.initCanvas(),a=this.gradients,a&&(this.type===i.GRADIENT_HORIZONTAL?(e=o,s=0):(e=s,o=0),a[e]||(h=r.createLinearGradient(0,0,o,s),h.addColorStop(0,this.startColorStr),h.addColorStop(1,this.endColorStr),a[e]={fillStyle:h,groups:{}}),a[e].groups[l]=!0,this.gradient_groups[l]=e)},removeGroup:function(i){var e,a,h,r=i.name;this.canvas_initialized||this.initCanvas(),a=this.gradients,a&&(h=this.gradient_groups,void 0!==h[r]&&(e=h[r],delete h[r],a[e]&&(h=a[e].groups,h[r]&&(delete h[r],t.isEmptyObject(h)&&delete a[e]))))},drawBackground:function(t,e){var a,h=e.width,r=e.height;this.fillStyle?t.fillStyle=this.fillStyle:(a=this.type===i.GRADIENT_HORIZONTAL?h:r,t.fillStyle=this.gradients[a].fillStyle),t.fill()}}),t.extend(i.PAnimation,{drawBackground:function(t,e){var a=this.options.img,h=this.fillStyle;e.options.backgroundType===i.BACKGROUND_STRETCHED?i.safeDrawImage(t,a,0,0,a.width,a.height,0,0,e.width,e.height):(h||(h=t.createPattern(a,"repeat"),this.fillStyle=h),t.fillStyle=h,t.fill())}}),t.extend(i.PSprite,{draw:function(){var t,e=this.options,a=e.animation,h=e.angle,r=e.scaleh,o=e.scalev,s=e.alpha,l=this.animation_options,n=this.width,d=this.height,p=e.currentFrame,g=i.ctx;this.insidePlayground&&a&&s&&r&&o&&!e.hidden&&(g.save(),g.translate(this.centerx,this.centery),h&&g.rotate(h),(1!==r||1!==o)&&g.scale(r,o),t=i.globalAlpha,1!==s&&(i.globalAlpha*=s,g.globalAlpha=i.globalAlpha),i.safeDrawImage(g,l.img,l.offsetx+e.multix+p*l.deltax,l.offsety+e.multiy+p*l.deltay,n,d,-this.halfWidth,-this.halfHeight,n,d),g.restore(),i.globalAlpha=t)}}),e.PSpriteGroup=i.pick(i.PSpriteGroup,["init","remove","draw"]),t.extend(i.PSpriteGroup,{init:function(a,h,r){var o,s,l;this.old_options={},r||(s=h.width+"",l=h.height+"",o=t(['<canvas id="',i.domPrefix,a,'" width ="',s,'" height="',l,'"></canvas>'].join("")).prependTo(h.parentDOM),o.addClass(i.cssClass),o.css({left:"0px",top:"0px",width:[s,"px"].join(""),height:[l,"px"].join(""),overflow:"hidden"}),this.dom=o,i.ctx=o.get(0).getContext("2d")),e.PSpriteGroup.init.apply(this,arguments)},remove:function(){var t=this.options.background,i=this.old_options.background;e.PSpriteGroup.remove.apply(this,arguments),i&&i.removeGroup&&i.removeGroup(this),t&&t.removeGroup&&t.removeGroup(this),this.dom&&this.dom.remove()},draw:function(){var t,a,h,r=this.options,o=this.old_options,s=this.parent,l=this.left,n=this.top,d=this.width,p=this.height,g=this.insidePlayground,u=g&&r.background,c=o.background,f=r.angle,v=r.scaleh,m=r.scalev,w=r.alpha,y=r.crop,G=i.ctx;s||(i.ctx.clearRect(0,0,d,p),i.globalAlpha=1),g&&(u!==c?(c&&c.removeGroup&&c.removeGroup(this),u&&u.addGroup&&u.addGroup(this),o.width=d,o.height=p,o.background=u):(d!==o.width||p!==o.height)&&(u&&(u.removeGroup&&u.removeGroup(this),u.addGroup&&u.addGroup(this)),o.width=d,o.height=p)),(this.layers.length||u)&&w&&v&&m&&!r.hidden&&(f||1!==v||1!==m?(G.save(),h=!0,G.translate(this.centerx,this.centery),f&&G.rotate(f),(1!==v||1!==m)&&G.scale(v,m),G.translate(-this.halfWidth,-this.halfHeight)):l||n?(G.save(),h=!0,G.translate(l,n)):h=!1,t=i.globalAlpha,1!==w?(i.globalAlpha*=w,G.globalAlpha=i.globalAlpha,a=!0):a=!1,(u||y)&&(G.beginPath(),G.rect(0,0,d,p)),u&&u.drawBackground(G,this),y&&(h||(G.save(),h=!0),G.clip()),e.PSpriteGroup.draw.apply(this,arguments),h?G.restore():a&&(G.globalAlpha=t),i.globalAlpha=t)}}),i.safeDrawImage=function(t,i,e,a,h,r,o,s,l,n){i&&t&&(0>e&&(o-=l/h*e,h+=e,e=0),0>a&&(s-=n/r*a,r+=a,a=0),e+h>i.width&&(l=l/h*(i.width-e),h=i.width-e),a+r>i.height&&(n=n/r*(i.height-a),r=i.height-a),r>0&&h>0&&i.width>e&&i.height>a&&t.drawImage(i,e,a,h,r,o,s,l,n))}})(jQuery,friGame);